# PanguPay TransferAreaInterface - 前端联调测试方案（本地）

> 目标：基于当前前端已实现的功能，提供一份完整、可执行的本地联调测试方案。
> 该方案可用于前后端联调与最终验收清单。

---

## 0. 范围与覆盖

本文档覆盖 `TransferAreaInterface` 当前**已实现的前端功能**，包括：
- 账户创建/导入、加密、账户状态隔离
- 路由/模板加载与页面生命周期
- 钱包主页与地址管理
- 加入/退出组织与组织详情展示
- 地址验证（组织/币种/公钥）、胶囊地址
- 转账流程（普通/快速/跨链）、UTXO + TXCer 逻辑
- 交易状态轮询/SSE 实时更新
- 交易历史/提示/本地持久化
- 国际化/主题/无障碍/性能模式/离线与 SW

---

## 1. 测试环境检查

### 1.1 后端节点可用
- [√] BootNode 已启动且可访问
- [√] ComNode（Leader）已启动且可访问
- [√] AssignNode 已启动（目标担保组织）
- [√] AggrNode 已启动（目标担保组织）
- [√] Gateway HTTP 服务可访问（默认 `http://localhost:8080`）

### 1.2 前端环境
- [√] Node.js / npm 已安装（推荐 v18+）
- [√] 前端 dev server 已启动（`npm run dev`）
- [√] API 基础地址配置正确（`js/config/api.ts`）
- [√] 浏览器缓存已清理或强制刷新（避免旧 SW）

### 1.3 数据与账号
- [√] 至少两个测试账户（A：发送方，B：接收方）
- [√] 至少一个已加入担保组织的账户
- [√] 至少一个散户账户（未加入组织）
- [√] 有可用的 8 位组织 ID

---

## 2. 测试数据准备

> 用于准备一致的本地测试数据，请将占位符替换为真实值。

**通用占位**
- BootNode: `http://localhost:8080`
- ComNode 端点：由 `/api/v1/committee/endpoint` 返回
- Group ID: `10000000`（示例）

**测试账户**
- 账户 A（发送方）：`UserID = ________`
- 账户 B（接收方）：`UserID = ________`
- 地址 A1（PGC）：`________`
- 地址 B1（PGC）：`________`

**前置条件**
- [ ] 账户 A 有可用 UTXO（或 TXCer）
- [ ] 账户 B 地址已上链且可被查询
- [ ] ComNode 端点缓存有效（或可刷新）

---

## 3. 端到端主流程测试

> 这些流程覆盖多个功能点，组成完整用户路径。

### 流程 A：新用户创建 -> 加密 -> 进入钱包
- [ ] 打开 `/#/welcome`，确认页面正常加载
- [ ] 点击“创建新账号”，等待生成完成
- [ ] 验证账号信息显示（accountId / address / keys）
- [ ] 设置密码（应弹出加密提示）
- [ ] 确认私钥加密成功，明文清理
- [ ] 跳转 `/#/main`，确认钱包页面渲染
- [ ] 刷新页面，确认 Store 状态持久（账号仍存在）

期望：
- 用户数据写入 localStorage 与 Store
- 路由/模板加载无控制台报错

### 流程 B：加入组织 -> 获取组织信息 -> SSE 同步
- [ ] 进入 `/#/join-group`，按 ID 搜索组织
- [ ] 点击加入（出现签名解锁提示）
- [ ] 确认加入成功 toast
- [ ] 进入 `/#/main`，组织面板显示组织详情
- [ ] 确认账户轮询启动（SSE 已连接提示）
- [ ] 刷新页面，组织信息仍在且 SSE 重新连接

期望：
- `getJoinedGroup()` 返回带 endpoints 的组织信息
- SSE 事件可用（无反复连接刷屏）

### 流程 C：收到 TXCer -> 使用 TXCer -> 确认
> 需要 A/B 在同一担保组织内。
- [ ] 账户 A 发起快速转账到 B（PGC）
- [ ] 账户 B 收到 TXCer（toast + 钱包更新）
- [ ] 账户 B 使用 TXCer 发起快速转账
- [ ] TXCer 锁定转入 submitted（无双花）
- [ ] 交易状态变为成功，TXCer 转换/清除

期望：
- B 在链上确认前可见 TXCer
- TXCer 状态变更与发送无竞态问题

### 流程 D：普通转账（散户 / ComNode）
> 需要散户账户（未加入组织）。
- [ ] 使用散户账号登录
- [ ] 准备普通转账（模式仍为 quick 但走散户路径）
- [ ] 提交到 ComNode `/api/v1/com/submit-noguargroup-tx`
- [ ] 确认成功 toast 与历史记录
- [ ] 验证 UTXO 本地锁定生效

期望：
- 无 AssignNode 错误；走 ComNode 路径
- UI 显示 pending（散户不轮询状态）

### 流程 E：跨链转账（UTXO -> 轻计算区）
- [ ] 确保用户在组织内且有 PGC
- [ ] 转账页选择跨链模式
- [ ] 校验 ETH/BTC 地址格式
- [ ] 提交跨链交易
- [ ] 确认提交成功并显示 pending toast

期望：
- 跨链限制生效（单收款人、仅 PGC）
- 后端 TXType=6

### 流程 F：胶囊地址（生成 -> 验证 -> 转账）
> 至少有一个自有地址。
- [ ] 在钱包地址卡片点击“展示收款地址”
- [ ] 生成胶囊地址（orgId@payload）
- [ ] 复制胶囊地址到收款输入框
- [ ] 点击“验证”，确认成功（不展示真实地址）
- [ ] 使用已验证胶囊地址完成转账

期望：
- 篡改 payload 验证失败
- 组织公钥缓存可复用

---

## 4. 功能级检查清单

### 4.1 路由 / 模板 / 基础 UI
- [ ] Hash 路由正常（`/welcome`、`/login`、`/main` 等）
- [ ] 模板懒加载正常（无 404 或缺失 HTML）
- [ ] `pageManager` / `templateLoader` 无报错
- [ ] 页面切换全局清理无重复事件
- [ ] 页脚随页面切换显示/隐藏正常

### 4.2 账户创建 / 导入
- [ ] 创建新账户（密钥生成、accountId 正确）
- [ ] 私钥导入（合法/非法处理）
- [ ] 多账户隔离（“使用另一个账号”）
- [ ] 个人资料页昵称/头像可更新
- [ ] 刷新页面账户数据持久化

### 4.3 私钥加密 / 解锁
- [ ] 创建账户后完成私钥加密
- [ ] 触发签名动作弹出解锁（加入组织/发送交易/胶囊）
- [ ] 密码错误提示正确
- [ ] 旧数据迁移（如存在 legacy key）

### 4.4 钱包与地址管理
- [ ] 钱包概览显示（余额/利息）
- [ ] 创建子地址（PGC/BTC/ETH）
- [ ] 地址列表刷新与 UI 状态稳定
- [ ] 导出私钥（弹窗 + 成功提示）
- [ ] 解绑地址（组织内）：签名 + API 成功
- [ ] 删除地址（仅本地）若支持
- [ ] 收款地址（胶囊）弹窗与复制正常

### 4.5 组织管理
- [ ] 组织列表/搜索（BootNode）正常
- [ ] 加入组织（UserFlowMsg 签名）
- [ ] 退出组织（签名请求，AddressMsg 为空）
- [ ] 组织详情页显示成员/端点
- [ ] 重新登录后组织信息刷新正常

### 4.6 地址验证 / 自动填充
- [ ] 普通地址验证
- [ ] 胶囊地址验证（解码 + 验签）
- [ ] 后端返回 Type 自动填充币种（0/1/2）
- [ ] Type 缺失 -> 默认 PGC + toast 提示
- [ ] 地址不存在 -> 错误提示

### 4.7 转账（构造 + 提交）
- [ ] 组织内快速转账（AssignNode）
- [ ] 散户普通转账（ComNode）
- [ ] 跨链转账（ETH/BTC 格式校验）
- [ ] 找零地址按币种生效
- [ ] 单收款人自动选源地址
- [ ] 额外支付 gas（PGC）输出生成

### 4.8 交易状态 / 历史
- [ ] 提交成功 -> 历史记录 pending
- [ ] 状态更新 -> 历史变为成功
- [ ] 失败交易 -> 标记失败原因
- [ ] 成功/失败时 UTXO 锁定/解锁
- [ ] 失败时 TXCer 解锁处理

### 4.9 轮询 + SSE
- [ ] 组织内 SSE 连接成功
- [ ] SSE 失败 -> 启动轮询兜底
- [ ] 账户更新正确应用（UTXO 入/出）
- [ ] TXCer 状态变更正确（0/1/2）
- [ ] 跨组织 TXCer 轮询可用
- [ ] 区块高度变化触发利息累积

### 4.10 Service Worker / 离线
- [ ] Service Worker 注册成功
- [ ] 有新 SW 时出现更新提示
- [ ] 断网时显示离线提示
- [ ] 核心页面离线可访问（缓存生效）

### 4.11 国际化 / 主题 / 无障碍
- [ ] 语言切换（中/英）更新文案
- [ ] 主题切换（浅色/深色/自动）更新 CSS 变量
- [ ] 无障碍：aria 标签、focus 高亮、离线播报

### 4.12 性能模式
- [ ] 性能模式开关生效（省电模式）
- [ ] 批量渲染与 rAF 更新正常
- [ ] SSE 高频更新无明显卡顿

---

## 5. 错误处理测试

### 5.1 API 与网络
- [ ] BootNode 宕机 -> 显示“无法连接区块链网络”
- [ ] ComNode 返回 503 -> 清除缓存
- [ ] AssignNode 404 -> 显示“组织不存在”
- [ ] 超时 -> 友好提示
- [ ] 断网 -> 离线提示 + 安全重试

### 5.2 签名与序列化
- [ ] 密码错误 -> 签名失败 toast
- [ ] BigInt JSON 解析失败 -> 不崩溃
- [ ] 后端验签失败 -> 错误提示

### 5.3 业务逻辑
- [ ] 余额不足 -> toast 提示且不提交
- [ ] UTXO 已被使用 -> 解锁并提示
- [ ] TXCer 无效 -> 移除并提示
- [ ] 用户不在组织内 -> 错误码处理正确

---

## 6. 回归测试（重点）

- [ ] UTXO 锁定格式兼容（`txid + indexZ` vs `txid_indexZ`）
- [ ] 前端序列化与 Go 结构体顺序一致
- [ ] `not_found` 状态不会提前解锁 UTXO/TXCer
- [ ] 地址验证后自动填充币种
- [ ] 胶囊地址验证使用组织公钥缓存
- [ ] Store 持久化与会话隔离生效

---

## 7. 测试记录（人工填充）

**测试日期：** `________`  
**测试人：** `________`  
**后端版本：** `________`  
**前端版本：** `________`

**总体结果**
- [ ] 通过
- [ ] 未通过（原因如下）

**备注 / 问题**
- [ ] 问题 1：______________________
- [ ] 问题 2：______________________
- [ ] 问题 3：______________________

---

## 8. 排查要点速记

- 签名错误排查：
  - 排除字段为零值（非删除）
  - BigInt 字段序列化为数字（非字符串）
  - map key 排序且结构体字段顺序保持
- TXOutput 哈希不一致：
  - 使用后端返回的 UTXO.TXOutputs
  - 采用 BigInt 安全解析
- SSE 失败：
  - 检查 AssignNode 端点
  - 检查 CORS 与 host 归一化

---

## 9. 完成度汇总

- [ ] 端到端流程全部完成（第 3 节）
- [ ] 功能级检查全部完成（第 4 节）
- [ ] 错误处理全部完成（第 5 节）
- [ ] 回归测试全部完成（第 6 节）
